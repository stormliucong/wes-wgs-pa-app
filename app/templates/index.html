<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WES/WGS Pre-Authorization Form</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  </head>
  <body>
    <div class="container">
      <div style="text-align: right; margin-bottom: 1rem;">
        <a href="/ehr" style="color: #007bff; text-decoration: none;">üîç Patient Search (EHR)</a>
      </div>
      <h1>Pre-Authorization Request</h1>
      <div class="subtle">Whole Exome/Genome Sequencing (WES/WGS)</div>

      <div id="alert-box" class="alert" style="display:none"></div>
      <div id="form-errors" class="error" style="display:none"></div>

      <form id="pa-form">
        <!-- Step 1: Patient & Subscriber Information -->
        <section class="form-step active">
          <h2>Patient & Insurance</h2>
          <div class="grid">
            <div class="col-6">
              <label for="patient_first_name">First Name</label>
              <input id="patient_first_name" name="patient_first_name" required />
            </div>
            <div class="col-6">
              <label for="patient_last_name">Last Name</label>
              <input id="patient_last_name" name="patient_last_name" required />
            </div>
            <div class="col-4">
              <label for="dob">Date of Birth</label>
              <input id="dob" name="dob" type="date" required />
            </div>
            <div class="col-4">
              <label for="sex">Sex</label>
              <select id="sex" name="sex">
                <option value="">Select‚Ä¶</option>
                <option value="Female">Female</option>
                <option value="Male">Male</option>
                <option value="Intersex">Intersex</option>
                <option value="Unknown">Unknown</option>
              </select>
            </div>
            <div class="col-4">
              <label for="member_id">Medicaid/Member ID</label>
              <input id="member_id" name="member_id" placeholder="1234567890" required />
            </div>
            <div class="col-12">
              <label for="patient_address">Patient Address</label>
              <input id="patient_address" name="patient_address" />
            </div>
            <div class="col-6">
              <label for="subscriber_name">Subscriber Name (if not patient)</label>
              <input id="subscriber_name" name="subscriber_name" />
            </div>
            <div class="col-6">
              <label for="subscriber_relation">Subscriber Relationship</label>
              <select id="subscriber_relation" name="subscriber_relation">
                <option value="">Select‚Ä¶</option>
                <option value="Self">Self</option>
                <option value="Parent">Parent</option>
                <option value="Guardian">Guardian</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>
          <div class="actions">
            <button type="button" data-next="1">Next</button>
          </div>
        </section>

        <!-- Step 2: Ordering Provider & Laboratory -->
        <section class="form-step">
          <h2>Ordering Provider & Laboratory</h2>
          <div class="grid">
            <div class="col-8">
              <label for="provider_name">Provider Name</label>
              <input id="provider_name" name="provider_name" required />
            </div>
            <div class="col-4">
              <label for="provider_npi">Provider NPI</label>
              <input id="provider_npi" name="provider_npi" placeholder="10 digits" required 
                     pattern="[0-9]{10}" title="Provider NPI must be exactly 10 digits (numbers only, no spaces or dashes)" 
                     minlength="10" maxlength="10" inputmode="numeric" />
            </div>
            <div class="col-6">
              <label for="provider_phone">Provider Phone</label>
              <input id="provider_phone" name="provider_phone" type="tel" placeholder="(555) 555-5555" title="Enter a 10-digit phone number" />
            </div>
            <div class="col-6">
              <label for="provider_fax">Provider Fax</label>
              <input id="provider_fax" name="provider_fax" type="tel" placeholder="(555) 555-5555" title="Enter a 10-digit fax number" />
            </div>
            <div class="col-12">
              <label for="provider_address">Provider Address</label>
              <input id="provider_address" name="provider_address" />
            </div>
          </div>
          <hr />
          <div class="grid">
            <div class="col-8">
              <label for="lab_name">Performing Laboratory</label>
              <input id="lab_name" name="lab_name" />
            </div>
            <div class="col-4">
              <label for="lab_npi">Lab NPI</label>
              <input id="lab_npi" name="lab_npi" 
                     pattern="[0-9]{10}" title="Lab NPI must be exactly 10 digits (numbers only, no spaces or dashes)" 
                     minlength="10" maxlength="10" inputmode="numeric" />
            </div>
            <div class="col-12">
              <label for="lab_address">Lab Address</label>
              <input id="lab_address" name="lab_address" />
            </div>
          </div>
          <div class="actions">
            <button type="button" class="secondary" data-prev="0">Back</button>
            <button type="button" data-next="2">Next</button>
          </div>
        </section>

        <!-- Step 3: Test Requested -->
        <section class="form-step">
          <h2>Test Requested</h2>
          <!-- Add a subtitle instruction to fill in required test and its cpt codes -->
          <p>Please select the required test and its corresponding CPT codes.</p>
          <div class="grid">
            <div class="col-4">
              <label for="test_type">Test Type</label>
              <select id="test_type" name="test_type" required>
                <option value="" selected disabled>Select‚Ä¶</option>
                <option value="WES">WES ‚Äî Whole Exome Sequencing</option>
                <option value="WGS">WGS ‚Äî Whole Genome Sequencing</option>
              </select>
            </div>
            <div class="col-4">
              <label for="test_configuration">Configuration</label>
              <select id="test_configuration" name="test_configuration">
                <option value="Proband" selected>Proband</option>
                <option value="Duo">Duo</option>
                <option value="Trio">Trio</option>
              </select>
            </div>
            <div class="col-4">
              <label for="urgency">Urgency</label>
              <select id="urgency" name="urgency">
                <option value="Regular" selected>Regular</option>
                <option value="Expedited">Expedited</option>
              </select>
            </div>
            <div class="col-6">
              <label for="specimen_type">Specimen Type</label>
              <select id="specimen_type" name="specimen_type">
                <option value="Blood" selected>Blood</option>
                <option value="Saliva">Saliva</option>
                <option value="Buccal">Buccal</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="col-6">
              <label for="collection_date">Collection Date</label>
              <input id="collection_date" name="collection_date" type="date" />
            </div>
            <div class="col-12">
              <label>CPT Codes</label>
              <div class="cpt-grid">
                <div class="cpt-item">
                  <input type="checkbox" id="cpt_81415" name="cpt_codes" value="81415" />
                  <label for="cpt_81415">81415</label>
                </div>
                <div class="cpt-item">
                  <input type="checkbox" id="cpt_81416" name="cpt_codes" value="81416" />
                  <label for="cpt_81416">81416</label>
                </div>
                <div class="cpt-item">
                  <input type="checkbox" id="cpt_81417" name="cpt_codes" value="81417" />
                  <label for="cpt_81417">81417</label>
                </div>
                <div class="cpt-item">
                  <input type="checkbox" id="cpt_81425" name="cpt_codes" value="81425" />
                  <label for="cpt_81425">81425</label>
                </div>
                <div class="cpt-item">
                  <input type="checkbox" id="cpt_81426" name="cpt_codes" value="81426" />
                  <label for="cpt_81426">81426</label>
                </div>
                <div class="cpt-item">
                  <input type="checkbox" id="cpt_81427" name="cpt_codes" value="81427" />
                  <label for="cpt_81427">81427</label>
                </div>
              </div>
            </div>
            <div class="col-12">
              <label for="internal_test_code">Internal Test Code (Optional)</label>
              <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
              <input id="internal_test_code" name="internal_test_code" type="text" placeholder="Enter internal test code" />
              <button type="button" id="search-test-code-btn" class="secondary" style="white-space: nowrap;">Search Lab Codes</button>
              </div>
            </div>

            <!-- Modal for Lab Test Codes -->
            <div id="lab-codes-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
              <div style="background: white; margin: 2rem auto; padding: 2rem; border-radius: 8px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
              <h3>Lab Internal Test Codes</h3>
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                <tr style="border-bottom: 2px solid #ddd;">
                  <th style="padding: 0.5rem; text-align: left;">Lab</th>
                  <th style="padding: 0.5rem; text-align: left;">Configuration</th>
                  <th style="padding: 0.5rem; text-align: left;">Test Code</th>
                </tr>
                </thead>
                <tbody id="lab-codes-tbody">
                <tr><td style="padding: 0.5rem;">GeneDx</td><td style="padding: 0.5rem;">WES proband, regular</td><td style="padding: 0.5rem;">561b</td></tr>
                <tr><td style="padding: 0.5rem;">GeneDx</td><td style="padding: 0.5rem;">WES duo, regular</td><td style="padding: 0.5rem;">561e</td></tr>
                <tr><td style="padding: 0.5rem;">GeneDx</td><td style="padding: 0.5rem;">WES trio, regular</td><td style="padding: 0.5rem;">561a</td></tr>
                <tr><td style="padding: 0.5rem;">GeneDx</td><td style="padding: 0.5rem;">WES proband, expedited</td><td style="padding: 0.5rem;">896b</td></tr>
                <tr><td style="padding: 0.5rem;">GeneDx</td><td style="padding: 0.5rem;">WES duo, expedited</td><td style="padding: 0.5rem;">896e</td></tr>
                <tr><td style="padding: 0.5rem;">GeneDx</td><td style="padding: 0.5rem;">WES trio, expedited</td><td style="padding: 0.5rem;">896a</td></tr>
                <tr><td style="padding: 0.5rem;">GeneDx</td><td style="padding: 0.5rem;">WGS proband, regular</td><td style="padding: 0.5rem;">J774b</td></tr>
                <tr><td style="padding: 0.5rem;">GeneDx</td><td style="padding: 0.5rem;">WGS duo, regular</td><td style="padding: 0.5rem;">J774e</td></tr>
                <tr><td style="padding: 0.5rem;">GeneDx</td><td style="padding: 0.5rem;">WGS trio, regular</td><td style="padding: 0.5rem;">J774a</td></tr>
                <tr><td style="padding: 0.5rem;">GeneDx</td><td style="padding: 0.5rem;">WGS proband, expedited</td><td style="padding: 0.5rem;">TH78b</td></tr>
                <tr><td style="padding: 0.5rem;">GeneDx</td><td style="padding: 0.5rem;">WGS duo, expedited</td><td style="padding: 0.5rem;">TH78e</td></tr>
                <tr><td style="padding: 0.5rem;">GeneDx</td><td style="padding: 0.5rem;">WGS trio, expedited</td><td style="padding: 0.5rem;">TH78a</td></tr>
                <tr><td style="padding: 0.5rem;">Labcorp</td><td style="padding: 0.5rem;">WES proband, for both regular and expedited</td><td style="padding: 0.5rem;">620024</td></tr>
                <tr><td style="padding: 0.5rem;">Labcorp</td><td style="padding: 0.5rem;">WES duo, for both regular and expedited</td><td style="padding: 0.5rem;">620023</td></tr>
                <tr><td style="padding: 0.5rem;">Labcorp</td><td style="padding: 0.5rem;">WES trio, for both regular and expedited</td><td style="padding: 0.5rem;">620022</td></tr>
                <tr><td style="padding: 0.5rem;">Labcorp</td><td style="padding: 0.5rem;">WGS proband, regular</td><td style="padding: 0.5rem;">WGS003</td></tr>
                <tr><td style="padding: 0.5rem;">Labcorp</td><td style="padding: 0.5rem;">WGS duo, regular</td><td style="padding: 0.5rem;">WGS008</td></tr>
                <tr><td style="padding: 0.5rem;">Labcorp</td><td style="padding: 0.5rem;">WGS trio, regular</td><td style="padding: 0.5rem;">WGS001</td></tr>
                <tr><td style="padding: 0.5rem;">Labcorp</td><td style="padding: 0.5rem;">WGS proband, expedited</td><td style="padding: 0.5rem;">WGS003X</td></tr>
                <tr><td style="padding: 0.5rem;">Labcorp</td><td style="padding: 0.5rem;">WGS duo, expedited</td><td style="padding: 0.5rem;">WGS008X</td></tr>
                <tr><td style="padding: 0.5rem;">Labcorp</td><td style="padding: 0.5rem;">WGS trio, expedited</td><td style="padding: 0.5rem;">WGS001X</td></tr>
                <tr><td style="padding: 0.5rem;">Invitae</td><td style="padding: 0.5rem;">WES proband, for both regular and expedited</td><td style="padding: 0.5rem;">80001</td></tr>
                <tr><td style="padding: 0.5rem;">Invitae</td><td style="padding: 0.5rem;">WES duo, for both regular and expedited</td><td style="padding: 0.5rem;">80002</td></tr>
                <tr><td style="padding: 0.5rem;">Invitae</td><td style="padding: 0.5rem;">WES trio, for both regular and expedited</td><td style="padding: 0.5rem;">80003</td></tr>
              </tbody>
              </table>
              <div style="margin-top: 1rem; text-align: right;">
                <button type="button" class="secondary" id="close-modal-btn">Close</button>
              </div>
              </div>
            </div>
          </div>
          <div class="actions">
            <button type="button" class="secondary" data-prev="1">Back</button>
            <button type="button" data-next="3">Next</button>
          </div>
        </section>

        <!-- Step 4: Diagnoses & Clinical Information -->
        <section class="form-step">
          <h2>Diagnoses & Clinical Information</h2>
          <!-- add a subtitle insturction to fill in relevant clinical and fx indication for required test -->
          <p>Fill in relevant clinical indications for the required test.</p>
          <div class="grid">
            <div class="col-12">
              <label>ICD-10 Codes</label>
              <div id="icd-list"></div>
              <div class="actions">
                <button type="button" class="secondary" id="add-icd">Add ICD Code</button>
              </div>
            </div>
            <div class="col-12">
              <label>Rationale for Testing</label>
              <div>
                <p>The patient's clinical presentation is strongly suggestive of an underlying genetic disorder (select applicable features):</p>
                <div class="checkbox-group" style="margin-top:0.5rem;">
                  <div class="checkbox-item">
                    <input type="checkbox" id="genetic_disorder" name="genetic_disorder" value="genetic_disorder" />
                    <label for="genetic_disorder">The patient's clinical presentation is strongly suggestive of an underlying genetic disorder (select applicable features):</label>
                  </div>
                  <div style="margin-left: 1.5rem;">
                    <div class="checkbox-item">
                      <input type="checkbox" id="mca" name="mca" value="congenital_anomalies" />
                      <label for="mca">Multiple congenital anomalies</label>
                    </div>
                    <div class="checkbox-item">
                      <input type="checkbox" id="dd_or_id" name="dd_or_id" value="developmental_delay" />
                      <label for="dd_or_id">Global developmental delay or intellectual disabilities</label>
                    </div>
                    <div class="checkbox-item">
                      <input type="checkbox" id="dysmorphic" name="dysmorphic" value="dysmorphic_features" />
                      <label for="dysmorphic">Dysmorphic features or physical findings suggestive of syndromic diagnosis</label>
                    </div>
                    <div class="checkbox-item">
                      <input type="checkbox" id="neurological" name="neurological" value="neurological_symptoms" />
                      <label for="neurological">Unexplained neurological symptoms (e.g., epilepsy, movement disorder, dystonia, ataxia)</label>
                    </div>
                    <div class="checkbox-item">
                      <input type="checkbox" id="metabolic" name="metabolic" value="metabolic" />
                      <label for="metabolic">Unexplained metabolic phenotype (e.g., lactic acidosis, hypoglycemia, metabolic decompensation)</label>
                    </div>
                    <div class="checkbox-item">
                      <input type="checkbox" id="autism" name="autism" value="autism_disorder" />
                      <label for="autism">Autism spectrum disorder with additional red-flag features (e.g., seizures, dysmorphism, regression)</label>
                    </div>
                    <div class="checkbox-item">
                      <input type="checkbox" id="early_onset" name="early_onset" value="early_onset" />
                      <label for="early_onset">Early-onset, progressive, or multisystem disease</label>
                    </div>
                  </div>
                  <div class="checkbox-item" style="margin-top:0.5rem;">
                    <input type="checkbox" id="prior_test_negative" name="prior_test_negative" value="prior_testing" />
                    <label for="prior_test_negative">Previous testing (CMA, gene-panel, or single gene) did not yield a diagnosis, and WES/WGS is the most appropriate next step</label>
                  </div>
                  <div class="checkbox-item">
                    <input type="checkbox" id="family_history" name="family_history" value="family_history" />
                    <label for="family_history">Family history is significant for conditions suggesting a genetic disorder, or pedigree information raises suspicion for heritable etiology</label>
                  </div>
                  <div class="checkbox-item" style="margin-top:0.5rem;">
                    <input type="checkbox" id="rationale_other" name="rationale_other" value="other" />
                    <label for="rationale_other">Other</label>
                  </div>
                  <textarea id="other_details" name="other_details" rows="3" placeholder="Please provide more details" style="width:100%;"></textarea>
                </div>
              </div>
            </div>
          </div>
          
          <div class="actions">
            <button type="button" class="secondary" data-prev="2">Back</button>
            <button type="button" data-next="4">Next</button>
          </div>
        </section>

        <!-- Step 5: Prior Testing -->
        <section class="form-step">
          <h2>Prior Testing</h2>
          <div class="grid">
            <div class="col-12">
              <label>Prior Genetic Testing</label>
              <div id="prior-tests-list"></div>
              <div class="actions">
                <button type="button" class="secondary" id="add-prior-test">Add Prior Test</button>
              </div>
            </div>
          </div>
          <div class="actions">
            <button type="button" class="secondary" data-prev="3">Back</button>
            <button type="button" data-next="5">Next</button>
          </div>
        </section>

        <!-- Step 6: Medical Necessity & Consent -->
        <section class="form-step">
          <h2>Medical Necessity & Consent</h2>
          <div class="grid">
            <div class="col-12">
              <label>Medical Necessity (check all that apply):</label>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input type="checkbox" id="mn_suspected_genetic" name="mn_suspected_genetic" />
                  <label for="mn_suspected_genetic">Suspected genetic etiology</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="mn_results_influence_management" name="mn_results_influence_management" />
                  <label for="mn_results_influence_management">Results will influence clinical management</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="mn_genetic_counseling" name="mn_genetic_counseling" />
                  <label for="mn_genetic_counseling">Genetic counseling provided/arranged</label>
                </div>
              </div>
            </div>
            <div class="col-12" style="margin-top: 20px;">
              <label>Consent</label>
              <div class="checkbox-item">
                <input type="checkbox" id="consent_ack" name="consent_ack" required />
                <label for="consent_ack">I confirm consent for testing and sharing information for authorization.</label>
              </div>
            </div>
            <div class="col-6">
              <label for="provider_signature">Ordering Provider Signature (type name)</label>
              <input id="provider_signature" name="provider_signature" required />
            </div>
            <div class="col-6">
              <label for="signature_date">Signature Date</label>
              <input id="signature_date" name="signature_date" type="date" required />
            </div>
          </div>
          <div class="actions">
            <button type="button" class="secondary" data-prev="4">Back</button>
            <button id="submitBtn" type="submit">Submit</button>
          </div>
        </section>
      </form>
      
      <!-- Admin link (discrete) -->
      <div style="text-align: center; margin-top: 3rem; opacity: 0.5;">
        <a href="{{ url_for('admin_login') }}" style="color: #666; text-decoration: none; font-size: 0.8rem;">Admin</a>
      </div>
    </div>

    <script src="{{ url_for('static', filename='app.js') }}"></script>
  </body>
</html>
